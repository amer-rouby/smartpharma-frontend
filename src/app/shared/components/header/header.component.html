<mat-toolbar color="primary" class="header-toolbar">

  <!-- Right Side -->
  <div class="header-right">
    <button mat-icon-button (click)="toggleSidebar.emit()" class="toggle-sidebar-btn"
      [matTooltip]="'HEADER.MENU' | translate">
      <mat-icon>menu</mat-icon>
    </button>

    <div class="logo-section" routerLink="/dashboard" [matTooltip]="'HEADER.BACK_TO_HOME' | translate">
      <div class="logo-icon">
        <mat-icon>local_pharmacy</mat-icon>
      </div>
      <div class="logo-text-container">
        <span class="logo-text">{{'APP.NAME' | translate}}</span>
        <span class="logo-subtitle">{{'APP.SUBTITLE' | translate}}</span>
      </div>
    </div>
  </div>

  <!-- Center: Search -->
  <div class="header-center">
    <div class="search-wrapper">
      <mat-form-field appearance="outline" class="search-field">
        <input matInput [value]="searchQuery()" (input)="searchQuery.set($any($event.target).value)"
          (keyup.enter)="onSearch()" (keydown)="onSearchKeydown($event)"
          [placeholder]="'HEADER.SEARCH_PLACEHOLDER' | translate">
        <mat-icon matPrefix>search</mat-icon>

        @if (searchQuery()) {
        <button mat-icon-button matSuffix (click)="clearSearch()" type="button"
          [matTooltip]="'COMMON.CLEAR' | translate">
          <mat-icon>close</mat-icon>
        </button>
        }
      </mat-form-field>
    </div>
  </div>

  <!-- Left Side: Actions -->
  <div class="header-left">

    <!-- Quick Add -->
    <button mat-stroked-button class="quick-add-btn" [matMenuTriggerFor]="quickActionsMenu"
      [matTooltip]="'HEADER.NEW' | translate">
      <mat-icon>add</mat-icon>
      <span>{{'HEADER.NEW' | translate}}</span>
    </button>

    <mat-menu #quickActionsMenu="matMenu" class="quick-actions-menu" xPosition="before">
      @for (action of quickActions; track action.route) {
      <button mat-menu-item [routerLink]="action.route">
        <mat-icon [color]="action.color">{{action.icon}}</mat-icon>
        <span>{{action.label | translate}}</span>
      </button>
      }
      <mat-divider></mat-divider>
      <button mat-menu-item routerLink="/reports">
        <mat-icon>assessment</mat-icon>
        <span>{{'NAV.REPORTS' | translate}}</span>
      </button>
    </mat-menu>

    <!-- ✅ Notifications - Professional Design -->
    <button mat-icon-button [matMenuTriggerFor]="notificationMenu" [matBadge]="unreadCount()" matBadgeColor="warn"
      class="notification-btn" [matTooltip]="'HEADER.NOTIFICATIONS' | translate">
      <mat-icon>notifications</mat-icon>
    </button>

    <mat-menu #notificationMenu="matMenu" class="notification-menu" xPosition="before">
      <!-- Header -->
      <div class="menu-header">
        <div class="header-content">
          <mat-icon>notifications</mat-icon>
          <h3>الإشعارات</h3>
        </div>
        @if (unreadCount() > 0) {
        <button mat-button color="primary" (click)="markAllAsRead()" class="mark-all-btn">
          <mat-icon>done_all</mat-icon>
          <span>تحديد الكل كمقروء</span>
        </button>
        }
      </div>
      <mat-divider></mat-divider>

      <!-- Notifications List -->
      <div class="notifications-list">
        @for (notification of notifications(); track notification.id; let i = $index) {
        @if (i < 10) { <button mat-menu-item class="notification-item" [class.unread]="!notification.read"
          (click)="onNotificationClick(notification)">

          <div class="notification-wrapper">
            <!-- Icon with gradient -->
            <div class="notification-icon-wrapper">
              <div class="notification-icon" [style.background]="getPriorityColor(notification.priority)">
                <mat-icon>{{getTypeIcon(notification.type)}}</mat-icon>
              </div>
              @if (!notification.read) {
              <span class="unread-indicator"></span>
              }
            </div>

            <!-- Content -->
            <div class="notification-body">
              <div class="notification-text">
                <p class="notification-message">{{notification.message}}</p>
                <span class="notification-time">{{formatDate(notification.createdAt)}}</span>
              </div>
            </div>
          </div>
          </button>
          }
          } @empty {
          <div class="no-notifications">
            <div class="empty-icon">
              <mat-icon>notifications_none</mat-icon>
            </div>
            <p class="empty-text">لا توجد إشعارات</p>
            <span class="empty-subtext">ستظهر الإشعارات الجديدة هنا</span>
          </div>
          }
      </div>

      <!-- Footer - View All -->
      @if (notifications().length > 0) {
      <mat-divider></mat-divider>
      <div class="menu-footer">
        <button mat-button color="primary" class="view-all-btn" (click)="viewAllNotifications()">
          <span>عرض جميع الإشعارات</span>
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
      }
    </mat-menu>

    <!-- User Profile -->
    <button mat-button [matMenuTriggerFor]="userMenu" class="user-profile-btn"
      [matTooltip]="'HEADER.PROFILE' | translate">
      <div class="user-info-mini">
        <div class="user-avatar">
          <mat-icon>account_circle</mat-icon>
        </div>
        <div class="user-details">
          <span class="user-name">{{userDisplayName()}}</span>
          <span class="user-role">{{userDisplayRole()}}</span>
        </div>
        <mat-icon class="dropdown-arrow">expand_more</mat-icon>
      </div>
    </button>

    <mat-menu #userMenu="matMenu" class="user-menu user-menu-wide" xPosition="before" yPosition="below">
      <div class="user-menu-header">
        <div class="user-menu-info">
          <p class="user-menu-name">
            <mat-icon>account_circle</mat-icon>
            <span>{{userDisplayName()}}</span>
          </p>
        </div>
      </div>

      <mat-divider></mat-divider>

      <button mat-menu-item routerLink="/settings/profile">
        <mat-icon>person_outline</mat-icon>
        <span>{{'HEADER.PROFILE' | translate}}</span>
      </button>

      <button mat-menu-item routerLink="/settings">
        <mat-icon>settings</mat-icon>
        <span>{{'NAV.SETTINGS' | translate}}</span>
      </button>

      <button mat-menu-item [matMenuTriggerFor]="languageMenu">
        <mat-icon>language</mat-icon>
        <span>{{'HEADER.LANGUAGE' | translate}}</span>
      </button>

      <button mat-menu-item routerLink="/help">
        <mat-icon>help_outline</mat-icon>
        <span>{{'HEADER.HELP' | translate}}</span>
      </button>

      <mat-divider></mat-divider>

      <button mat-menu-item (click)="logout()" class="logout-item">
        <mat-icon>exit_to_app</mat-icon>
        <span>{{'HEADER.LOGOUT' | translate}}</span>
      </button>
    </mat-menu>

    <!-- Language Submenu -->
    <mat-menu #languageMenu="matMenu" xPosition="before">
      <button mat-menu-item (click)="changeLanguage('ar')" [class.active]="currentLang() === 'ar'">
        <mat-icon>translate</mat-icon>
        <span>العربية</span>
        @if (currentLang() === 'ar') {
        <mat-icon color="accent">check</mat-icon>
        }
      </button>

      <button mat-menu-item (click)="changeLanguage('en')" [class.active]="currentLang() === 'en'">
        <mat-icon>translate</mat-icon>
        <span>English</span>
        @if (currentLang() === 'en') {
        <mat-icon color="accent">check</mat-icon>
        }
      </button>
    </mat-menu>

  </div>
</mat-toolbar>
