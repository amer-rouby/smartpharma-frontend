<div class="product-form-container">
  <app-page-header [title]="isEditMode ? 'تعديل منتج' : 'إضافة منتج جديد'"
    [subtitle]="isEditMode ? 'تحديث بيانات المنتج' : 'إدخال بيانات المنتج الجديد'" icon="inventory_2">
  </app-page-header>

  <mat-card>
    <mat-card-content>
      @if (loading && isEditMode) {
      <div class="loading-state">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
        <p>جاري تحميل البيانات...</p>
      </div>
      }

      @if (!loading || !isEditMode) {
      <form (ngSubmit)="onSubmit()">
        <div class="form-grid">
          <mat-form-field appearance="outline">
            <mat-label>اسم المنتج *</mat-label>
            <input matInput [(ngModel)]="product.name" name="name" required placeholder="مثال: بنادول إكسترا">
            <mat-icon matPrefix>inventory_2</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>الاسم العلمي</mat-label>
            <input matInput [(ngModel)]="product.scientificName" name="scientificName" placeholder="مثال: Paracetamol">
            <mat-icon matPrefix>science</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>الباركود</mat-label>
            <input matInput [(ngModel)]="product.barcode" name="barcode" placeholder="الباركود">
            <mat-icon matPrefix>qr_code_2</mat-icon>
            <button mat-icon-button matSuffix type="button" (click)="regenerateBarcode()"
              matTooltip="توليد باركود جديد">
              <mat-icon>refresh</mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>التصنيف</mat-label>
            <mat-select [(ngModel)]="product.category" name="category">
              @for (cat of categories; track cat) {
              <mat-option [value]="cat">{{cat}}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>نوع الوحدة</mat-label>
            <mat-select [(ngModel)]="product.unitType" name="unitType">
              @for (unit of unitTypes; track unit.value) {
              <mat-option [value]="unit.value">{{unit.label}}</mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>package</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>حد المخزون الأدنى</mat-label>
            <input matInput type="number" min="0" [(ngModel)]="product.minStockLevel" name="minStockLevel">
            <mat-icon matPrefix>warning</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>سعر الشراء</mat-label>
            <input matInput type="number" min="0" step="0.01" [(ngModel)]="product.buyPrice" name="buyPrice">
            <span matTextSuffix>ج.م</span>
            <mat-icon matPrefix>payments</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>سعر البيع *</mat-label>
            <input matInput type="number" min="0.01" step="0.01" [(ngModel)]="product.sellPrice" name="sellPrice"
              required>
            <span matTextSuffix>ج.م</span>
            <mat-icon matPrefix>attach_money</mat-icon>
          </mat-form-field>
        </div>

        <div class="checkbox-section">
          <mat-checkbox [(ngModel)]="product.prescriptionRequired" name="prescriptionRequired" color="primary">
            <div class="checkbox-content">
              <mat-icon>medication</mat-icon>
              <span>يتطلب وصفة طبية</span>
            </div>
          </mat-checkbox>
        </div>

        <div class="form-actions">
          <button mat-button type="button" (click)="onCancel()" color="warn" [disabled]="loading">
            <mat-icon>close</mat-icon>
            <span>إلغاء</span>
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading">
            @if (!loading) {
            <mat-icon>save</mat-icon>
            } @else {
            <mat-spinner diameter="20"></mat-spinner>
            }
            <span>{{loading ? 'جاري الحفظ...' : (isEditMode ? 'تحديث' : 'إضافة')}}</span>
          </button>
        </div>
      </form>
      }
    </mat-card-content>
  </mat-card>
</div>
