<!-- src/app/features/stock/stock-batch-form/stock-batch-form.component.html -->

<div class="batch-form-container">
  <app-page-header
    [title]="(isEditMode() ? 'STOCK.EDIT_BATCH' : 'STOCK.ADD_BATCH') | translate"
    [subtitle]="(isEditMode() ? 'STOCK.EDIT_SUBTITLE' : 'STOCK.ADD_SUBTITLE') | translate"
    icon="inventory_2">

    <button mat-button type="button" (click)="onCancel()">
      <mat-icon>arrow_back</mat-icon>
      <span>{{'COMMON.CANCEL' | translate}}</span>
    </button>
  </app-page-header>

  <mat-card>
    <mat-card-content>
      <form [formGroup]="batchForm" (ngSubmit)="onSubmit()" class="batch-form">

        <!-- Product Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{'PRODUCTS.NAME' | translate}} *</mat-label>
          <mat-select formControlName="productId" required>
            @for (product of productsList(); track product.id) {
              <mat-option [value]="product.id">
                {{product.name}} ({{product.barcode}})
              </mat-option>
            } @empty {
              <mat-option disabled>
                {{'PRODUCTS.NO_PRODUCTS' | translate}}
              </mat-option>
            }
          </mat-select>
          @if (batchForm.get('productId')?.invalid && batchForm.get('productId')?.touched) {
            <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
          }
        </mat-form-field>

        <!-- Batch Number -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{'STOCK.BATCH_NUMBER' | translate}} *</mat-label>
          <input matInput formControlName="batchNumber"
                 [placeholder]="'STOCK.BATCH_NUMBER_PLACEHOLDER' | translate">
          @if (batchForm.get('batchNumber')?.invalid && batchForm.get('batchNumber')?.touched) {
            <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
          }
        </mat-form-field>

        <!-- Quantity & Initial Quantity -->
        <div class="row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{'STOCK.CURRENT_STOCK' | translate}} *</mat-label>
            <input matInput type="number" formControlName="quantityCurrent" min="0">
            @if (batchForm.get('quantityCurrent')?.invalid && batchForm.get('quantityCurrent')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{'STOCK.INITIAL_STOCK' | translate}}</mat-label>
            <input matInput type="number" formControlName="quantityInitial" min="0">
          </mat-form-field>
        </div>

        <!-- Dates Row -->
        <div class="row">
          <!-- Expiry Date - REQUIRED -->
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{'PRODUCTS.EXPIRY_DATE' | translate}} *</mat-label>
            <input matInput [matDatepicker]="expiryPicker"
                   formControlName="expiryDate" required>
            <mat-datepicker-toggle matIconSuffix [for]="expiryPicker"></mat-datepicker-toggle>
            <mat-datepicker #expiryPicker></mat-datepicker>
            @if (batchForm.get('expiryDate')?.invalid && batchForm.get('expiryDate')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
            }
          </mat-form-field>

          <!-- Production Date - Optional -->
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{'STOCK.PRODUCTION_DATE' | translate}}</mat-label>
            <input matInput [matDatepicker]="productionPicker"
                   formControlName="productionDate">
            <mat-datepicker-toggle matIconSuffix [for]="productionPicker"></mat-datepicker-toggle>
            <mat-datepicker #productionPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Location -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{'STOCK.LOCATION' | translate}}</mat-label>
          <input matInput formControlName="location"
                 [placeholder]="'STOCK.LOCATION_PLACEHOLDER' | translate">
        </mat-form-field>

        <!-- Shelf/Warehouse -->
        <div class="row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{'STOCK.SHELF' | translate}}</mat-label>
            <input matInput formControlName="shelf" placeholder="A-01">
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{'STOCK.WAREHOUSE' | translate}}</mat-label>
            <input matInput formControlName="warehouse" placeholder="Main">
          </mat-form-field>
        </div>

        <!-- Notes -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{'COMMON.NOTES' | translate}}</mat-label>
          <textarea matInput formControlName="notes" rows="3"></textarea>
        </mat-form-field>

        <!-- Status (for edit mode) -->
        @if (isEditMode()) {
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{'PRODUCTS.STATUS' | translate}}</mat-label>
            <mat-select formControlName="status">
              <mat-option value="ACTIVE">{{'PRODUCTS.ACTIVE' | translate}}</mat-option>
              <mat-option value="EXPIRED">{{'STOCK.STATUS_EXPIRED' | translate}}</mat-option>
              <mat-option value="DISCARDED">{{'STOCK.STATUS_DISCARDED' | translate}}</mat-option>
            </mat-select>
          </mat-form-field>
        }

        <!-- Submit Buttons -->
        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit"
                  [disabled]="batchForm.invalid || loading()">
            @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              <mat-icon>save</mat-icon>
            }
            <span>{{isEditMode() ? ('COMMON.UPDATE' | translate) : ('COMMON.SAVE' | translate)}}</span>
          </button>

          <button mat-button type="button" (click)="onCancel()">
            {{'COMMON.CANCEL' | translate}}
          </button>
        </div>

      </form>
    </mat-card-content>
  </mat-card>
</div>
