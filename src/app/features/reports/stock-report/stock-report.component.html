<div class="reports-container">
  <!-- ✅ Page Header -->
  <app-page-header [title]="'REPORTS.STOCK_REPORTS' | translate" [subtitle]="'REPORTS.STOCK_DESC' | translate"
    icon="inventory">
    <button mat-raised-button color="primary" (click)="exportPDF()">
      <mat-icon>picture_as_pdf</mat-icon> PDF
    </button>
  </app-page-header>

  <!-- ✅ Filters Card -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <!-- Report Type -->
        <mat-form-field appearance="outline">
          <mat-label>{{'REPORTS.REPORT_TYPE' | translate}}</mat-label>
          <mat-select [(ngModel)]="reportType">
            <mat-option value="CURRENT">{{'REPORTS.CURRENT' | translate}}</mat-option>
            <mat-option value="MONTHLY">{{'REPORTS.MONTHLY' | translate}}</mat-option>
            <mat-option value="YEARLY">{{'REPORTS.YEARLY' | translate}}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Generate Button -->
        <button mat-raised-button color="primary" (click)="generateReport()" [disabled]="reportLoading()">
          @if (reportLoading()) {
          <mat-spinner diameter="20"></mat-spinner>
          } @else {
          <mat-icon>refresh</mat-icon>
          }
          <span>{{reportLoading() ? ('COMMON.LOADING' | translate) : ('REPORTS.GENERATE' | translate)}}</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ✅ Loading State -->
  @if (reportLoading()) {
  <div class="loading-overlay">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>{{'COMMON.LOADING' | translate}}</p>
  </div>
  }

  <!-- ✅ Error State -->
  @if (reportError()) {
  <mat-card class="error-card">
    <mat-icon color="warn">error_outline</mat-icon>
    <p>{{reportError() | translate}}</p>
    <button mat-raised-button color="primary" (click)="generateReport()">
      {{'COMMON.RETRY' | translate}}
    </button>
  </mat-card>
  }

  <!-- ✅ Data State -->
  @if (!reportLoading() && !reportError() && stockReportData()) {

  <!-- Stats Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%)">
          <mat-icon>account_balance_wallet</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{formatCurrency(stockReportData()!.totalStockValue)}}</h3>
          <p>{{'STOCK.STOCK_VALUE' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)">
          <mat-icon>inventory_2</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{stockReportData()!.totalItems}}</h3>
          <p>{{'STOCK.TOTAL_ITEMS' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">
          <mat-icon>warning</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{stockReportData()!.lowStockItems}}</h3>
          <p>{{'STOCK.LOW_STOCK' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%)">
          <mat-icon>event_busy</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{stockReportData()!.expiredItems}}</h3>
          <p>{{'STOCK.EXPIRED' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Grid -->
  <div class="charts-grid">
    <!-- Bar Chart - Stock by Category -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>{{'STOCK.CATEGORY_STOCK' | translate}}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart [data]="barChartData" [options]="barChartOptions" [type]="'bar'">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Doughnut Chart - Stock Status -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>{{'STOCK.STOCK_STATUS' | translate}}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart [data]="doughnutChartData" [options]="doughnutChartOptions" [type]="'doughnut'">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Tables Section with Tabs -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>{{'STOCK.STOCK_DETAILS' | translate}}</mat-card-title>

      <!-- Table Tabs -->
      <div class="table-tabs">
        <button mat-stroked-button [class.active]="activeTable() === 'categories'"
          (click)="setActiveTable('categories')">
          {{'STOCK.BY_CATEGORY' | translate}}
        </button>
        <button mat-stroked-button [class.active]="activeTable() === 'low-stock'" (click)="setActiveTable('low-stock')">
          {{'STOCK.LOW_STOCK' | translate}}
        </button>
        <button mat-stroked-button [class.active]="activeTable() === 'expiring'" (click)="setActiveTable('expiring')">
          {{'STOCK.EXPIRING' | translate}}
        </button>
      </div>
    </mat-card-header>

    <mat-card-content>

      <!-- Categories Table -->
      @if (activeTable() === 'categories') {
      <table mat-table [dataSource]="categoryTableData()" class="data-table">

        <ng-container matColumnDef="categoryName">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.CATEGORY' | translate}}</th>
          <td mat-cell *matCellDef="let row"><strong>{{row.categoryName}}</strong></td>
        </ng-container>

        <ng-container matColumnDef="itemCount">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.ITEM_COUNT' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip class="small-chip">{{row.itemCount}}</mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="totalValue">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.TOTAL_VALUE' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <strong>{{formatCurrency(row.totalValue)}}</strong>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['categoryName', 'itemCount', 'totalValue']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['categoryName', 'itemCount', 'totalValue'];"></tr>
      </table>

      @if (categoryTableData().length === 0) {
      <div class="empty-state">
        <mat-icon>category</mat-icon>
        <p>{{'REPORTS.NO_DATA' | translate}}</p>
      </div>
      }
      }

      <!-- Low Stock Table -->
      @if (activeTable() === 'low-stock') {
      <table mat-table [dataSource]="lowStockTableData()" class="data-table">

        <ng-container matColumnDef="productName">
          <th mat-header-cell *matHeaderCellDef>{{'PRODUCTS.NAME' | translate}}</th>
          <td mat-cell *matCellDef="let row"><strong>{{row.productName}}</strong></td>
        </ng-container>

        <ng-container matColumnDef="batchNumber">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.BATCH' | translate}}</th>
          <td mat-cell *matCellDef="let row"><code>{{row.batchNumber}}</code></td>
        </ng-container>

        <ng-container matColumnDef="currentStock">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.CURRENT' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <div class="stock-progress">
              <mat-progress-bar mode="determinate" [value]="row.progress" color="warn"></mat-progress-bar>
              <span class="progress-text">{{row.currentStock}} / {{row.minStock}}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="expiryDate">
          <th mat-header-cell *matHeaderCellDef>{{'PRODUCTS.EXPIRY' | translate}}</th>
          <td mat-cell *matCellDef="let row">{{row.expiryDate | date:'yyyy-MM-dd'}}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['productName', 'batchNumber', 'currentStock', 'expiryDate']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['productName', 'batchNumber', 'currentStock', 'expiryDate'];"></tr>
      </table>

      @if (lowStockTableData().length === 0) {
      <div class="empty-state">
        <mat-icon>check_circle</mat-icon>
        <p>{{'STOCK.NO_LOW_STOCK' | translate}}</p>
      </div>
      }
      }

      <!-- Expiring Table -->
      @if (activeTable() === 'expiring') {
      <table mat-table [dataSource]="expiringTableData()" class="data-table">

        <ng-container matColumnDef="productName">
          <th mat-header-cell *matHeaderCellDef>{{'PRODUCTS.NAME' | translate}}</th>
          <td mat-cell *matCellDef="let row"><strong>{{row.productName}}</strong></td>
        </ng-container>

        <ng-container matColumnDef="batchNumber">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.BATCH' | translate}}</th>
          <td mat-cell *matCellDef="let row"><code>{{row.batchNumber}}</code></td>
        </ng-container>

        <ng-container matColumnDef="daysUntilExpiry">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.DAYS_LEFT' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip [color]="getStatusColor(row.status)" class="small-chip">
              {{row.daysUntilExpiry}} {{'STOCK.DAYS' | translate}}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="expiryDate">
          <th mat-header-cell *matHeaderCellDef>{{'PRODUCTS.EXPIRY' | translate}}</th>
          <td mat-cell *matCellDef="let row">{{row.expiryDate | date:'yyyy-MM-dd'}}</td>
        </ng-container>

        <ng-container matColumnDef="currentStock">
          <th mat-header-cell *matHeaderCellDef>{{'STOCK.QUANTITY' | translate}}</th>
          <td mat-cell *matCellDef="let row">{{row.currentStock}}</td>
        </ng-container>

        <tr mat-header-row
          *matHeaderRowDef="['productName', 'batchNumber', 'daysUntilExpiry', 'expiryDate', 'currentStock']"></tr>
        <tr mat-row
          *matRowDef="let row; columns: ['productName', 'batchNumber', 'daysUntilExpiry', 'expiryDate', 'currentStock'];">
        </tr>
      </table>

      @if (expiringTableData().length === 0) {
      <div class="empty-state">
        <mat-icon>event_available</mat-icon>
        <p>{{'STOCK.NO_EXPIRING' | translate}}</p>
      </div>
      }
      }

    </mat-card-content>
  </mat-card>

  } @else if (!reportLoading() && !stockReportData() && !reportError()) {

  <!-- Initial Empty State -->
  <div class="empty-state">
    <mat-icon>analytics</mat-icon>
    <p>{{'REPORTS.SELECT_FILTERS' | translate}}</p>
    <button mat-raised-button color="primary" (click)="generateReport()">
      {{'REPORTS.GENERATE' | translate}}
    </button>
  </div>

  }
</div>
