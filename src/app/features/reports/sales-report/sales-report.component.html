<div class="reports-container">
  <!-- ✅ Page Header -->
  <app-page-header [title]="'REPORTS.SALES_REPORTS' | translate" [subtitle]="'REPORTS.SALES_DESC' | translate"
    icon="trending_up">
    <button mat-raised-button color="primary" (click)="exportPDF()">
      <mat-icon>picture_as_pdf</mat-icon> PDF
    </button>
    <button mat-raised-button color="accent" (click)="exportExcel()">
      <mat-icon>table_chart</mat-icon> Excel
    </button>
  </app-page-header>

  <!-- ✅ Filters Card -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filters-grid">
        <!-- Start Date -->
        <mat-form-field appearance="outline">
          <mat-label>{{'REPORTS.FROM' | translate}}</mat-label>
          <input matInput [matDatepicker]="fromPicker" [(ngModel)]="startDate">
          <mat-datepicker-toggle matSuffix [for]="fromPicker"></mat-datepicker-toggle>
          <mat-datepicker #fromPicker></mat-datepicker>
        </mat-form-field>

        <!-- End Date -->
        <mat-form-field appearance="outline">
          <mat-label>{{'REPORTS.TO' | translate}}</mat-label>
          <input matInput [matDatepicker]="toPicker" [(ngModel)]="endDate">
          <mat-datepicker-toggle matSuffix [for]="toPicker"></mat-datepicker-toggle>
          <mat-datepicker #toPicker></mat-datepicker>
        </mat-form-field>

        <!-- Report Type -->
        <mat-form-field appearance="outline">
          <mat-label>{{'REPORTS.REPORT_TYPE' | translate}}</mat-label>
          <mat-select [(ngModel)]="reportType">
            <mat-option value="DAILY">{{'REPORTS.DAILY' | translate}}</mat-option>
            <mat-option value="MONTHLY">{{'REPORTS.MONTHLY' | translate}}</mat-option>
            <mat-option value="YEARLY">{{'REPORTS.YEARLY' | translate}}</mat-option>
            <mat-option value="CUSTOM">{{'REPORTS.CUSTOM' | translate}}</mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Generate Button -->
        <button mat-raised-button color="primary" (click)="generateReport()" [disabled]="reportLoading()">
          @if (reportLoading()) {
          <mat-spinner diameter="20"></mat-spinner>
          } @else {
          <mat-icon>refresh</mat-icon>
          }
          <span>{{reportLoading() ? ('COMMON.LOADING' | translate) : ('REPORTS.GENERATE' | translate)}}</span>
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- ✅ Loading State -->
  @if (reportLoading()) {
  <div class="loading-overlay">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>{{'COMMON.LOADING' | translate}}</p>
  </div>
  }

  <!-- ✅ Error State -->
  @if (reportError()) {
  <mat-card class="error-card">
    <mat-icon color="warn">error_outline</mat-icon>
    <p>{{reportError() | translate}}</p>
    <button mat-raised-button color="primary" (click)="generateReport()">
      {{'COMMON.RETRY' | translate}}
    </button>
  </mat-card>
  }

  <!-- ✅ Data State (when loaded successfully) -->
  @if (!reportLoading() && !reportError() && salesReportData()) {

  <!-- Stats Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%)">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{formatCurrency(salesReportData()!.totalRevenue)}}</h3>
          <p>{{'REPORTS.TOTAL_REVENUE' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)">
          <mat-icon>receipt_long</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{salesReportData()!.totalOrders}}</h3>
          <p>{{'REPORTS.TOTAL_ORDERS' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">
          <mat-icon>shopping_cart</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{formatCurrency(salesReportData()!.averageOrder)}}</h3>
          <p>{{'REPORTS.AVERAGE_ORDER' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)">
          <mat-icon>inventory_2</mat-icon>
        </div>
        <div class="stat-info">
          <h3>{{salesReportData()!.totalItems}}</h3>
          <p>{{'REPORTS.TOTAL_ITEMS' | translate}}</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Grid -->
  <div class="charts-grid">
    <!-- Line Chart - Sales Trend -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>{{'REPORTS.SALES_TREND' | translate}}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart [data]="lineChartData" [options]="lineChartOptions" [type]="'line'">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Pie Chart - Payment Methods -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>{{'REPORTS.PAYMENT_METHODS' | translate}}</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas baseChart [data]="pieChartData" [options]="pieChartOptions" [type]="'doughnut'">
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Sales Details Section with Tabs -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>{{'REPORTS.SALES_DETAILS' | translate}}</mat-card-title>

      <!-- Table Tabs -->
      <mat-button-toggle-group [value]="activeTable()" (change)="setActiveTable($event.value)">
        <mat-button-toggle value="daily">{{'REPORTS.DAILY_SALES' | translate}}</mat-button-toggle>
        <mat-button-toggle value="products">{{'REPORTS.TOP_PRODUCTS' | translate}}</mat-button-toggle>
      </mat-button-toggle-group>
    </mat-card-header>

    <mat-card-content>

      <!-- Daily Sales Table -->
      @if (activeTable() === 'daily') {
      <table mat-table [dataSource]="dailySalesTableData()" class="data-table">

        <!-- Date Column -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>{{'SALES.DATE' | translate}}</th>
          <td mat-cell *matCellDef="let row">{{row.date | date:'yyyy-MM-dd'}}</td>
        </ng-container>

        <!-- Revenue Column -->
        <ng-container matColumnDef="revenue">
          <th mat-header-cell *matHeaderCellDef>{{'SALES.TOTAL' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <strong>{{formatCurrency(row.revenue)}}</strong>
          </td>
        </ng-container>

        <!-- Orders Column -->
        <ng-container matColumnDef="orders">
          <th mat-header-cell *matHeaderCellDef>{{'REPORTS.TOTAL_ORDERS' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip class="small-chip">{{row.orders}}</mat-chip>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="dailySalesColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: dailySalesColumns;"></tr>
      </table>

      @if (dailySalesTableData().length === 0) {
      <div class="empty-state">
        <mat-icon>receipt_long</mat-icon>
        <p>{{'REPORTS.NO_DATA' | translate}}</p>
      </div>
      }
      }

      <!-- Top Products Table -->
      @if (activeTable() === 'products') {
      <table mat-table [dataSource]="topProductsTableData()" class="data-table">

        <!-- Rank Column -->
        <ng-container matColumnDef="rank">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let row">{{row.rank}}</td>
        </ng-container>

        <!-- Product Name Column -->
        <ng-container matColumnDef="productName">
          <th mat-header-cell *matHeaderCellDef>{{'PRODUCTS.NAME' | translate}}</th>
          <td mat-cell *matCellDef="let row"><strong>{{row.productName}}</strong></td>
        </ng-container>

        <!-- Quantity Sold Column -->
        <ng-container matColumnDef="quantitySold">
          <th mat-header-cell *matHeaderCellDef>{{'SALES.QUANTITY' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <mat-chip class="small-chip">{{row.quantitySold}}</mat-chip>
          </td>
        </ng-container>

        <!-- Total Revenue Column -->
        <ng-container matColumnDef="totalRevenue">
          <th mat-header-cell *matHeaderCellDef>{{'SALES.TOTAL' | translate}}</th>
          <td mat-cell *matCellDef="let row">
            <strong>{{formatCurrency(row.totalRevenue)}}</strong>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="topProductsColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: topProductsColumns;"></tr>
      </table>

      @if (topProductsTableData().length === 0) {
      <div class="empty-state">
        <mat-icon>inventory_2</mat-icon>
        <p>{{'REPORTS.NO_DATA' | translate}}</p>
      </div>
      }
      }

    </mat-card-content>
  </mat-card>

  } @else if (!reportLoading() && !salesReportData() && !reportError()) {

  <!-- Initial Empty State -->
  <div class="empty-state">
    <mat-icon>analytics</mat-icon>
    <p>{{'REPORTS.SELECT_FILTERS' | translate}}</p>
    <button mat-raised-button color="primary" (click)="generateReport()">
      {{'REPORTS.GENERATE' | translate}}
    </button>
  </div>

  }
</div>
