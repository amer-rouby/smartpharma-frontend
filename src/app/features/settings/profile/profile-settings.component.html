<div class="profile-settings-container">
  <app-page-header [title]="'SETTINGS.PROFILE' | translate" [subtitle]="'SETTINGS.PROFILE_SUBTITLE' | translate"
    icon="person">
  </app-page-header>

  <mat-card>
    <mat-card-content>
      @if (loading()) {
      <div class="loading-state">
        <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
        <p>{{'COMMON.LOADING' | translate}}</p>
      </div>
      }

      @if (!loading() && profile()) {
      <div class="profile-header">
        <div class="avatar-section">
          @if (profile()?.profileImageUrl) {
          <img [src]="profile()?.profileImageUrl" alt="Profile" class="profile-avatar">
          } @else {
          <div class="profile-avatar-placeholder">
            <mat-icon>person</mat-icon>
          </div>
          }
          <div class="user-info">
            <h2>{{profile()?.fullName}}</h2>
            <p>{{getRoleLabel(profile()?.role || '')}}</p>
            <small class="text-muted">{{'PROFILE.LAST_LOGIN' | translate}}:
              {{formatDate(profile()?.lastLoginAt)}}</small>
          </div>
        </div>
      </div>

      <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-form">

        <!-- Personal Information -->
        <div class="form-section">
          <h3 class="section-title">{{'PROFILE.PERSONAL_INFO' | translate}}</h3>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.FULL_NAME' | translate}} *</mat-label>
              <input matInput formControlName="fullName">
              @if (profileForm.get('fullName')?.invalid && profileForm.get('fullName')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.EMAIL' | translate}} *</mat-label>
              <input matInput formControlName="email" type="email">
              @if (profileForm.get('email')?.hasError('email') && profileForm.get('email')?.touched) {
              <mat-error>{{'VALIDATION.EMAIL_INVALID' | translate}}</mat-error>
              }
              @if (profileForm.get('email')?.hasError('required') && profileForm.get('email')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.PHONE' | translate}}</mat-label>
              <input matInput formControlName="phone">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.GENDER' | translate}}</mat-label>
              <mat-select formControlName="gender">
                @for (gender of genders; track gender.value) {
                <mat-option [value]="gender.value">{{gender.label | translate}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        <!-- Professional Information -->
        <div class="form-section">
          <h3 class="section-title">{{'PROFILE.PROFESSIONAL_INFO' | translate}}</h3>

          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.JOB_TITLE' | translate}}</mat-label>
              <input matInput formControlName="jobTitle">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.DEPARTMENT' | translate}}</mat-label>
              <input matInput formControlName="department">
            </mat-form-field>
          </div>
        </div>

        <!-- Address Information -->
        <div class="form-section">
          <h3 class="section-title">{{'PROFILE.ADDRESS_INFO' | translate}}</h3>

          <div class="form-grid">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{'PROFILE.ADDRESS' | translate}}</mat-label>
              <input matInput formControlName="address">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.CITY' | translate}}</mat-label>
              <input matInput formControlName="city">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.COUNTRY' | translate}}</mat-label>
              <input matInput formControlName="country">
            </mat-form-field>
          </div>
        </div>

        <!-- Bio -->
        <div class="form-section">
          <h3 class="section-title">{{'PROFILE.BIO' | translate}}</h3>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{'PROFILE.BIO_PLACEHOLDER' | translate}}</mat-label>
            <textarea matInput formControlName="bio" rows="4"></textarea>
            <mat-hint align="end">{{profileForm.get('bio')?.value?.length || 0}}/500</mat-hint>
          </mat-form-field>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button mat-button type="button" (click)="loadProfile()" color="warn" [disabled]="loading()">
            <mat-icon>refresh</mat-icon>
            <span>{{'COMMON.CANCEL' | translate}}</span>
          </button>
          <button mat-raised-button color="primary" type="submit" [disabled]="loading() || profileForm.invalid">
            @if (loading()) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            <mat-icon>save</mat-icon>
            }
            <span>{{loading() ? ('COMMON.SAVING' | translate) : ('COMMON.SAVE' | translate)}}</span>
          </button>
        </div>
      </form>

      <!-- Change Password Section -->
      <div class="password-section">
        <button mat-button color="primary" (click)="togglePasswordForm()">
          <mat-icon>lock</mat-icon>
          <span>{{showPasswordForm() ? ('PROFILE.HIDE_PASSWORD' | translate) : ('PROFILE.CHANGE_PASSWORD' |
            translate)}}</span>
        </button>

        @if (showPasswordForm()) {
        <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()" class="password-form">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.OLD_PASSWORD' | translate}}</mat-label>
              <input matInput formControlName="oldPassword" type="password">
              @if (passwordForm.get('oldPassword')?.invalid && passwordForm.get('oldPassword')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.NEW_PASSWORD' | translate}}</mat-label>
              <input matInput formControlName="newPassword" type="password">
              @if (passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{'PROFILE.CONFIRM_PASSWORD' | translate}}</mat-label>
              <input matInput formControlName="confirmPassword" type="password">
              @if (passwordForm.get('confirmPassword')?.hasError('passwordMismatch') &&
              passwordForm.get('confirmPassword')?.touched) {
              <mat-error>{{'VALIDATION.PASSWORD_MISMATCH' | translate}}</mat-error>
              }
              @if (passwordForm.get('confirmPassword')?.hasError('required') &&
              passwordForm.get('confirmPassword')?.touched) {
              <mat-error>{{'VALIDATION.REQUIRED' | translate}}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-actions">
            <button mat-button type="button" (click)="togglePasswordForm()" color="warn">
              <mat-icon>close</mat-icon>
              <span>{{'COMMON.CANCEL' | translate}}</span>
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="loading() || passwordForm.invalid">
              @if (loading()) {
              <mat-spinner diameter="20"></mat-spinner>
              } @else {
              <mat-icon>lock_open</mat-icon>
              }
              <span>{{'PROFILE.CHANGE_PASSWORD' | translate}}</span>
            </button>
          </div>
        </form>
        }
      </div>
      }
    </mat-card-content>
  </mat-card>
</div>
